from __future__ import annotations

import datetime as dt


def build_system_prompt() -> str:
    return (
        "Ты эксперт по созданию персональных поздравлений от Сбербанка для клиентов.\n"
        "Твоя задача — создать уникальное, тёплое и содержательное поздравление, которое демонстрирует "
        "индивидуальный подход к каждому клиенту.\n\n"
        "КРИТИЧЕСКИ ВАЖНЫЕ ПРАВИЛА:\n"
        "- Используй ТОЛЬКО факты из блока FACTS (не выдумывай детали о компании, достижениях, проектах, истории сотрудничества).\n"
        "- Имя/отчество: используй только то, что есть в FACTS. Если отчество пустое/отсутствует — НЕ придумывай его.\n"
        "- Не добавляй и не запрашивай чувствительные данные (паспорт, номера карт, PIN/CVV и т.п.).\n"
        "- Тон: деловой/тёплый в зависимости от сегмента клиента и типа праздника, без фамильярности, без политических/спорных тем.\n"
        "- Не упоминай тему/вид последнего взаимодействия с клиентом; используй только общую благодарность за сотрудничество.\n"
        "- Каждое поздравление должно быть УНИКАЛЬНЫМ — избегай шаблонных фраз и одинаковых начал.\n"
        "- Проверь грамматику, пунктуацию и согласование в русском языке.\n"
        "- Выводи РОВНО JSON без markdown и без лишнего текста.\n"
    )


def build_user_prompt(
    *,
    event_type: str,
    event_title: str,
    event_date: dt.date,
    segment: str,
    facts: dict,
    tone_hint: str | None = None,
) -> str:
    """Build user prompt for greeting generation.

    Args:
        event_type: birthday|holiday|manual
        event_title: название события
        event_date: дата события
        segment: сегмент клиента (VIP, standard, etc.)
        facts: словарь с фактами о клиенте
        tone_hint: подсказка тона из holiday_tags (official|warm), если есть
    """
    # Определяем рекомендацию по тону
    tone_guidance = ""
    if tone_hint:
        if tone_hint.lower() == "official":
            tone_guidance = "Рекомендуемый тон: official (деловой, уважительный)."
        elif tone_hint.lower() == "warm":
            tone_guidance = "Рекомендуемый тон: warm (тёплый, дружелюбный)."
    elif segment.lower() == "vip":
        tone_guidance = (
            "Клиент VIP-сегмента: используй более деловой тон (official), но сохраняй теплоту."
        )
    else:
        tone_guidance = "Используй тёплый тон (warm), но оставайся профессиональным."

    # Персонализация в зависимости от типа события
    personalization_guidance = ""
    if event_type.lower() == "birthday":
        personalization_guidance = (
            "ПЕРСОНАЛИЗАЦИЯ для дня рождения:\n"
            "- Используй имя и отчество ТОЛЬКО если отчество дано в FACTS (middle_name).\n"
            "- Если middle_name пустое/отсутствует: обращайся по имени (или имя+фамилия для official), но НЕ выдумывай отчество.\n"
            "- Если известна компания: упомяни успехи в работе, но БЕЗ конкретных проектов/цифр.\n"
            "- Если известна должность: свяжи пожелания с профессиональным развитием, но БЕЗ выдуманных деталей.\n"
            "- Добавь пожелания, которые подходят именно этому человеку (здоровье, успех в делах, гармония).\n"
        )
    else:
        # holiday или manual
        personalization_guidance = (
            "ПЕРСОНАЛИЗАЦИЯ для праздника:\n"
            "- Адаптируй поздравление под конкретный праздник, учитывая его суть и значение.\n"
            "- Используй имя клиента естественно, не перегружая.\n"
            "- Если известна компания: свяжи пожелания с бизнес-контекстом, но БЕЗ конкретных проектов.\n"
            "- Если известна должность: учитывай профессиональную роль, но БЕЗ выдуманных достижений.\n"
            "- Для каждого праздника найди уникальный угол: что он значит для бизнеса/личности.\n"
        )

    # Строим промпт
    prompt_parts = [
        "Сгенерируй персональное поздравление от Сбербанка.\n\n",
        "FACTS о клиенте (используй ТОЛЬКО эти данные, не выдумывай ничего):\n",
        f"{facts}\n\n",
        "КОНТЕКСТ события:\n",
        f"- Тип события: {event_type}\n",
        f"- Название: {event_title}\n",
        f"- Дата: {event_date.isoformat()}\n",
        f"- Сегмент клиента: {segment}\n",
        f"- {tone_guidance}\n\n",
        personalization_guidance,
        "\nТРЕБОВАНИЯ к тексту (ОБЯЗАТЕЛЬНО соблюдай):\n",
        "- subject: 6..80 символов, привлекательный заголовок с упоминанием праздника\n",
        "- body: МИНИМУМ 450 символов (целевой диапазон 600-900 символов, максимум 1200), 3-5 абзацев, без списков\n",
        "  КРИТИЧЕСКИ ВАЖНО: body должен быть НЕ МЕНЕЕ 450 символов. Короткие тексты (менее 450 символов) НЕДОПУСТИМЫ.\n",
        "- Структура body:\n",
        "  • Открытие: уникальное вступление (НЕ шаблонное «Поздравляем с...»)\n",
        "  • Основная часть: персонализированные пожелания, связанные с FACTS (2-3 абзаца)\n",
        "  • Заключение: благодарность «Спасибо, что остаётесь с нами» (без упоминания тем последних контактов)\n",
        "- РАЗНООБРАЗИЕ: каждый текст должен быть уникальным — используй разные формулировки, начинай по-разному\n",
        "- ЕСТЕСТВЕННОСТЬ: текст должен звучать как написанный человеком, не как шаблон\n",
        "- РЕЛЕВАНТНОСТЬ: адаптируй поздравление под конкретный праздник (Новый год, 8 Марта, день рождения и т.д.)\n",
        "- НЕ упоминай: 'ИИ', 'модель', 'промпт', внутренние процессы, конкретные банковские продукты\n\n",
        "OUTPUT JSON schema:\n",
        "{\n",
        '  "tone": "official|warm",\n',
        '  "subject": "string",\n',
        '  "body": "string"\n',
        "}\n",
    ]

    return "".join(prompt_parts)
