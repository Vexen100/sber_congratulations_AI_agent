# Инструкция по установке и запуску (Windows, локальное демо)

Эта инструкция рассчитана на **офлайн/локальную** демонстрацию MVP.

## 1) Установка

Самый простой способ:

```bat
scripts\setup_backend.cmd
```

Скрипт:
- создаст `backend\.venv`
- установит зависимости
- создаст `backend\.env` из `backend\env.example` (если `.env` ещё нет)

## 2) Запуск

```bat
scripts\run_backend.cmd
```

По умолчанию сервер поднимается на **8001**. Если на Windows выбранный порт запрещён/занят (например, `WinError 10013`),
скрипт **автоматически выберет ближайший доступный порт** и выведет его в консоль.

## (Опционально) Включить “реальный” LLM

По умолчанию проект работает в офлайн-режиме (`LLM_MODE=template`). Чтобы включить LLM:

1) Открой `backend\.env` и выставь:

```
LLM_MODE=openai
OPENAI_API_KEY=...
```

2) При необходимости укажи OpenAI-compatible endpoint/модель:

```
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MODEL=gpt-4o-mini
```

## (Опционально) Включить GigaChat (текст и/или открытки)

1) Открой `backend\.env` и выставь:

```
LLM_MODE=gigachat
IMAGE_MODE=gigachat
GIGACHAT_CREDENTIALS=...   # Authorization Key
```

2) Если возникают TLS ошибки, см. установку сертификата в `instruction_gigachat.md`.
Для демо (не рекомендуется в проде) можно временно:

```
GIGACHAT_VERIFY_SSL_CERTS=false
```

## End-to-end проверка GigaChat (smoke test)

Когда переменные окружения настроены, можно прогнать e2e smoke-test (1 текст + 1 открытка):

```bat
scripts\run_gigachat_smoke.cmd
```

Результаты сохраняются в `backend\data\smoke\`.

### Если нужен другой порт

```bat
set PORT=8000
scripts\run_backend.cmd
```

### Если порт «залип»

Иногда после прошлых запусков на Windows порт может остаться занятым/подвисшим.

```bat
scripts\kill_port.cmd 8000
```

## 3) Демо (2 клика)

1. Откройте `http://127.0.0.1:8001/`
2. Нажмите **Seed demo data** — пересоздаст 5 демо‑клиентов (случайный набор), дни рождения будут сегодня/в ближайшие дни.
3. Нажмите **Run agent now**
4. Посмотрите результаты:
   - вкладки **Greetings** и **Deliveries**
   - файлы outbox: `backend\data\outbox\`
   - открытки: `backend\data\cards\`

Если вы уже запускали агента раньше и видите много `skipped`/мало новых файлов — это нормально (идемпотентность).
Для “чистого” демо нажмите в UI **Reset runtime data** и запустите агент снова.

Важно: агент **может сгенерировать поздравления заранее**, но отправка происходит **только в день события**.  
Для VIP поздравлений approve можно сделать заранее — доставка всё равно будет в день события (в регулярном режиме/при запуске агента в этот день).

## (Опционально) Регулярный режим (планировщик)

Запуск:

```bat
scripts\run_scheduler.cmd
```

Принципы регулярного режима:
- Планировщик запускает агента **каждый день в 09:00** (в таймзоне `TZ`, по умолчанию `Europe/Moscow`).
- Агент заранее генерирует поздравления на горизонт `LOOKAHEAD_DAYS`.
- Доставка происходит **только в день события** (event_date == today). VIP поздравления отправляются только если заранее одобрены в UI.
- Для удобства демо планировщик делает **один запуск сразу при старте**.

## (Опционально) Реальная отправка по email (SMTP)

По умолчанию отправка идёт в outbox-файлы (`SEND_MODE=file`). Для реальной отправки:

1) В `backend\.env` установите:

```
SEND_MODE=smtp
SMTP_HOST=...
SMTP_PORT=587
SMTP_USERNAME=...
SMTP_PASSWORD=...
SMTP_FROM_EMAIL=...
```

2) **Безопасность по умолчанию**: реальная отправка блокируется, пока вы не настроите allowlist доменов:

```
SMTP_ALLOWLIST_DOMAINS=mycompany.com,gmail.com
SMTP_ALLOW_ALL_RECIPIENTS=false
```

3) Дополнительно:
- Демо-клиенты (`is_demo=true`) и адреса вида `*@example.com` никогда не отправляются через SMTP.
- Если `SEND_MODE=smtp`, то для демо-клиентов отправка **падает обратно в outbox-файлы** (чтобы демо и VIP approval работали безопасно).
- Для VIP сегмента остаётся ручное подтверждение (Approve).


