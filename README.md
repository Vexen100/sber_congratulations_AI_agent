# Sber Congratulations AI Agent (MVP)

MVP-проект: **автоматизированный конвейер подготовки и доставки персонализированных поздравлений** клиентам/организациям Сбера на основе событий (ДР, праздники, памятные даты, ручные триггеры), с веб-интерфейсом для контроля статусов, ручных действий и последующего развития.

## Репозиторий

- **CI**: GitHub Actions workflow в `.github/workflows/ci.yml` (ruff/black/pytest)
- **Handoff для нового чата (Cursor)**: начните с `AI_HANDOFF.md` и `docs/DECISIONS.md`

## Что входит в MVP

- **Регулярный/событийный триггер**: поиск ближайших событий (на N дней вперёд) + ручной запуск сотрудником.
- **Извлечение данных**: базовая CRM-модель (клиенты/контакты/сегменты/история) + праздники.
- **Генерация контента**:
  - выбор тона/шаблона по типу события и сегменту,
  - персонализация (имя/отчество/компания/должность; без выдумывания фактов и без утечек тем последних контактов),
  - генерация «открытки» (картинка) в виде файла.
- **VIP approval**: для клиентов сегмента `vip` поздравление создаётся со статусом `needs_approval` и **отправляется только после подтверждения** в UI.
- **Доставка**: MVP-канал отправки в **outbox (файлы)** + лог доставки (идемпотентность).
- **Аудит запусков агента**: каждый запуск фиксируется как `AgentRun` и отображается в UI (Dashboard → “Последние запуски”, отдельная страница “Agent runs”).
- **Постоянное улучшение**: задел под сбор фидбэка (оценка/комментарий) и дальнейшее обучение/ранжирование шаблонов.
- **Веб-интерфейс**: просмотр клиентов/событий/поздравлений/доставок, создание клиента, ручной триггер, запуск агента.
- **Тесты**: базовая проверка детектора событий и идемпотентной отправки.

## Архитектура (упрощённо)

1) **Detector** находит события на горизонте \(N\) дней: ДР клиентов + праздники из справочника.  
2) **Agent Orchestrator** собирает контекст, выбирает тон/шаблон, генерирует текст/картинку.  
3) **Sender** доставляет через канал (в MVP: файловый outbox), фиксирует Delivery с **idempotency_key**.  
4) **Web/UI + API** даёт контроль и ручные операции.

Ключевой принцип доставки: **поздравления могут генерироваться заранее (на горизонт N дней), но отправка происходит только в день события**.  
Для VIP — только после ручного approve (approve можно сделать заранее, отправка всё равно будет в день события).

## Структура репозитория

```
backend/                 # FastAPI + web UI (Jinja) + SQLite + агент + планировщик
  app/
  tests/
  requirements.txt
  requirements-dev.txt
  env.example
scripts/                 # удобные команды для Windows
ROADMAP.md
```

## Скрипты (Windows)

- **`scripts/setup_backend.cmd`**: создаёт `backend/.venv`, ставит зависимости, создаёт `backend/.env` из `backend/env.example`.
- **`scripts/run_backend.cmd`**: запускает web UI + API (по умолчанию порт **8001**; можно переопределить через `PORT`).
- **`scripts/run_scheduler.cmd`**: запускает планировщик (демо «регулярного» режима).
- **`scripts/kill_port.cmd`**: освобождает порт (если после прошлых запусков остались «залипшие» процессы).

## Быстрый старт (локально, Windows)

### 1) Требования

- **Python 3.10+** (MVP не требует 3.11; важно для Windows-демо)

### 2) Установка

Самый простой вариант:

```bat
scripts\setup_backend.cmd
```

Либо вручную:

```bat
cd backend
python -m venv .venv
.venv\Scripts\activate
pip install -r requirements.txt -r requirements-dev.txt
copy env.example .env
```

### 3) Запуск веб-интерфейса + API

```bat
cd ..
scripts\run_backend.cmd
```

По умолчанию используется порт **8001**, но на некоторых Windows-окружениях отдельные порты могут быть запрещены (WinError 10013).
Скрипт запуска в этом случае **автоматически подберёт ближайший доступный порт** и выведет его в консоль.

Если нужен конкретный порт (предпочтительный):

```bat
set PORT=8000
scripts\run_backend.cmd
```

Если порт “залип” после прошлых запусков:

```bat
scripts\kill_port.cmd 8000
```

### 4) Демо-сценарий (рекомендуемый)

1. В UI нажмите **Seed demo data** (слева) — он **пересоздаст** демо-набор из **5 случайных клиентов**.
   Дни рождения выбираются так, чтобы ближайшие события были **сегодня или в ближайшие дни** (без “прошлого”).
2. Нажмите **Run agent now** (на дашборде): агент создаст поздравления на ближайшие события.
3. Перейдите в **Greetings / Deliveries** и проверьте статусы.
4. Посмотрите «отправленные» материалы:
   - `backend\data\outbox\` (файлы сообщений),
   - `backend\data\cards\` (сгенерированные открытки).

## Переменные окружения

См. `backend/env.example`. Важное:
- **LOOKAHEAD_DAYS**: горизонт поиска событий.
- **MAX_HOLIDAY_RECIPIENTS**: лимит получателей на один праздник (чтобы не сжигать токены на демо).
- **MAX_GIGACHAT_IMAGES_PER_RUN**: лимит генераций изображений через GigaChat за один прогон (скорость/токены). Остальные картинки — Pillow fallback.
- **SEND_MODE**: `file` (MVP) — пишет письма в outbox.
- **OUTBOX_DIR**: куда «отправлять».
- **LLM_MODE**: `template` (по умолчанию, офлайн) или `openai` (OpenAI-compatible HTTP API).
- **IMAGE_MODE**: `pillow` (по умолчанию) или `gigachat` (генерация открыток через GigaChat).

### GigaChat (опционально)

Для интеграции с GigaChat укажите:
- `LLM_MODE=gigachat` и/или `IMAGE_MODE=gigachat`
- `GIGACHAT_CREDENTIALS` (Authorization Key)

Важно: для TLS может понадобиться корневой сертификат Минцифры (см. `instruction_gigachat.md`). В крайнем случае для демо можно временно отключить проверку сертификата: `GIGACHAT_VERIFY_SSL_CERTS=false`.

## End-to-end проверка GigaChat (smoke test)

После настройки `backend/.env` можно прогнать e2e smoke-test (1 текст + 1 открытка), который сохранит артефакты в `backend/data/smoke/`:

```bat
scripts\run_gigachat_smoke.cmd
```

## (Опционально) Планировщик

Если хотите показать «регулярный» режим, можно запустить планировщик (cron daily 09:00):

```bat
scripts\run_scheduler.cmd
```

Регулярный режим делает одно и то же каждый день:
- создаёт/обновляет события на горизонт `LOOKAHEAD_DAYS`
- генерирует поздравления заранее
- **отправляет только те поздравления, у которых дата события = сегодня** (VIP — только после approve)

Для удобства демо планировщик также делает **один запуск сразу при старте**, чтобы не ждать 09:00.

## Тесты

```bat
cd backend
.venv\Scripts\activate
pytest -q
```

## Как расширять после MVP

- Подключить реальную CRM (read-only реплика/ETL), аудит и роли доступа.
- Реальные каналы отправки (SMTP, SMS/мессенджеры) через адаптеры.
- Обогащение по ИНН: ОКВЭД/руководитель (интеграции/парсинг), кэширование.
- Контентные guardrails (политики, стоп-слова, антигаллюцинации, проверка фактов).
- Петля обучения: A/B шаблонов, метрики отклика, обучение ранжирования.


